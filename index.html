<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google Sheet å³æ™‚çœ‹æ¿</title>
  <style>
    :root { --radius: 12px; --shadow: 0 6px 22px rgba(0,0,0,.08); --border: 1px solid #e9e9ef; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 24px; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", sans-serif; background: #f6f7fb; color: #1f2330; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 14px; }
    h1 { font-size: 22px; margin: 0; letter-spacing: .5px; }
    .panel { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); border: var(--border); overflow: hidden; }
    .toolbar { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 12px; border-bottom: var(--border); background: #fafbff; }
    .search { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border: var(--border); border-radius: 10px; background: #fff; }
    .search input { border: none; outline: none; width: 100%; font-size: 14px; background: transparent; }
    .btn { padding: 8px 12px; border-radius: 10px; border: var(--border); background: #fff; cursor: pointer; font-size: 14px; }
    .btn:active { transform: translateY(1px); }
    .table-wrap { overflow: auto; max-height: calc(100vh - 220px); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 720px; }
    thead th { position: sticky; top: 0; background: #fff; z-index: 1; font-weight: 600; text-align: left; font-size: 13px; color: #3d4252; padding: 12px; border-bottom: var(--border); user-select: none; cursor: pointer; }
    tbody td { padding: 12px; border-bottom: 1px dashed #eef0f6; font-size: 14px; }
    tbody tr:hover { background: #fcfdff; }
    .badge { display: inline-block; padding: 2px 8px; font-size: 11px; border-radius: 999px; border: var(--border); background: #fff; }
    .status { display: inline-flex; gap: 6px; align-items: center; font-size: 12px; color: #606778; }
    .loading { padding: 32px; text-align: center; color: #606778; font-size: 14px; }
    .error { padding: 12px; color: #a40000; background: #fff3f3; border-top: 1px solid #ffd4d4; border-bottom: 1px solid #ffd4d4; font-size: 13px; }
    .sr { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0 0 0 0); white-space: nowrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Google Sheet å³æ™‚çœ‹æ¿</h1>
      <div class="status">
        <span class="badge" id="refresh-badge">æ¯ 5 ç§’æ›´æ–°</span>
        <span id="last-updated">â€”</span>
      </div>
    </header>

    <section class="panel">
      <div class="toolbar">
        <label class="search" title="è¼¸å…¥é—œéµå­—ä»¥éæ¿¾ï¼ˆå³æ™‚ï¼‰">
          <span>ğŸ”</span>
          <input id="q" placeholder="æœå°‹ï¼ˆæ”¯æ´ä»»æ„æ¬„ä½ï¼Œå¤§å°å¯«ä¸æ‹˜ï¼‰" />
        </label>
        <button class="btn" id="btn-refresh" title="ç«‹åˆ»æ›´æ–°">é‡æ–°æ•´ç†</button>
        <button class="btn" id="btn-export" title="åŒ¯å‡ºç›®å‰è¡¨æ ¼ç‚º CSV">åŒ¯å‡º CSV</button>
      </div>

      <div id="error" class="error" style="display:none;"></div>
      <div id="loading" class="loading">è¼‰å…¥ä¸­â€¦</div>

      <div class="table-wrap">
        <table id="table" aria-describedby="caption">
          <caption id="caption" class="sr">ç”± Google è©¦ç®—è¡¨è³‡æ–™å³æ™‚ç”¢ç”Ÿçš„è¡¨æ ¼</caption>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ======= ä½ çš„è¨­å®šï¼ˆå·²æ›¿ä½ å¡«å¥½ï¼‰ =======
    const SHEET_ID   = "1ha6zLeibz4RXKgasduTRFrIhzjJsKiXXmXHQXAmOUOM";
    const GID        = "0";                 // ä½ è²¼çš„ç¶²å€æ˜¯ .../edit?gid=0#gid=0
    const REFRESH_MS = 5000;                // è‡ªå‹•æ›´æ–°ï¼ˆæ¯«ç§’ï¼‰
    const QUERY_SQL  = "select *";          // æƒ³è¦å…ˆç¯©é¸/æ’åºå¯æ”¹ï¼ˆgviz SQL æ–¹è¨€ï¼‰

    // ======= å…§éƒ¨ç¨‹å¼ =======
    let rawHeaders = [];
    let rawRows = [];
    let sortState = { index: 0, dir: 1 };   // 1: å‡å†ª, -1: é™å†ª
    let timerId = null;

    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function gvizUrl() {
      const params = new URLSearchParams({
        tqx: "out:json",
        tq : QUERY_SQL,   // ç”¨ tq + gidï¼ˆä¸å†ç”¨ sheet nameï¼Œé¿å…æ‹¼éŒ¯ï¼‰
        gid: GID,
        _:  Date.now().toString()  // é˜²å¿«å–
      });
      return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?${params.toString()}`;
    }

    function setLoading(v) { const el=$("#loading"); if (el) el.style.display = v ? "block" : "none"; }
    function setError(msg) {
      const el = $("#error");
      if (!el) return;
      if (msg) { el.textContent = msg; el.style.display = "block"; }
      else { el.style.display = "none"; el.textContent = ""; }
    }

    async function fetchSheet() {
      setError(""); setLoading(true);
      try {
        const res  = await fetch(gvizUrl(), { cache: "no-store" });
        const text = await res.text();
        // gviz æœƒå›å‚³ google.visualization.Query.setResponse({...})ï¼›å‰æ‰åŒ…è£å‡½å¼
        const json = JSON.parse(text.replace(/^[^{]+/, "").replace(/;?$/, ""));
        if (!json || !json.table) throw new Error("å›æ‡‰æ ¼å¼ä¸æ­£ç¢º");
        const table = json.table;
        rawHeaders  = table.cols.map(c => (c.label || c.id || "").trim());
        rawRows     = table.rows.map(r => r.c.map(c => (c ? c.v : "")));
        render();
        const lu = $("#last-updated");
        if (lu) lu.textContent = "æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleString("zh-TW", { hour12:false });
      } catch (err) {
        console.error(err);
        setError("è®€å–è³‡æ–™ç™¼ç”Ÿå•é¡Œï¼Œè«‹ç¢ºèªåˆ†äº«æ¬Šé™æ˜¯å¦ç‚ºã€çŸ¥é“é€£çµçš„äººå¯æª¢è¦–ã€ã€‚");
      } finally {
        setLoading(false);
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function render() {
      // æœå°‹éæ¿¾
      const q = ($("#q")?.value || "").trim().toLowerCase();
      let rows = rawRows.filter(r => !q || r.some(cell => String(cell).toLowerCase().includes(q)));

      // æ’åº
      const { index, dir } = sortState;
      rows.sort((a, b) => {
        const x = a[index], y = b[index];
        const nx = parseFloat(x), ny = parseFloat(y);
        if (!isNaN(nx) && !isNaN(ny)) return (nx - ny) * dir;
        const dx = Date.parse(x), dy = Date.parse(y);
        if (!isNaN(dx) && !isNaN(dy)) return (dx - dy) * dir;
        return String(x).localeCompare(String(y), "zh-Hant") * dir;
      });

      // è¡¨é ­ / è¡¨èº«
      const headers = rawHeaders.length ? rawHeaders : rows[0]?.map((_,i)=>`æ¬„ä½${i+1}`) || [];
      const thead = $("#thead"), tbody = $("#tbody");
      if (thead) thead.innerHTML = `<tr>${
        headers.map((h,i) => {
          const arrow = sortState.index === i ? (sortState.dir === 1 ? "â–²" : "â–¼") : "â†•";
          return `<th data-idx="${i}" title="é»æ“Šæ’åº">${escapeHtml(h)} ${arrow}</th>`;
        }).join("")
      }</tr>`;
      if (tbody) tbody.innerHTML = rows.map(r =>
        `<tr>${r.map(x => `<td>${formatCell(x)}</td>`).join("")}</tr>`
      ).join("");

      // ç¶å®šæ’åºé»æ“Š
      $$("#thead th").forEach(th => {
        th.onclick = () => {
          const i = Number(th.getAttribute("data-idx"));
          if (sortState.index === i) sortState.dir *= -1;
          else { sortState.index = i; sortState.dir = 1; }
          render();
        };
      });
    }

    function formatCell(val) {
      const s = String(val ?? "");
      if (/\.(png|jpg|jpeg|gif|webp)(\?.*)?$/i.test(s)) {
        return `<img src="${escapeHtml(s)}" alt="" style="max-height:38px; border-radius:6px;" loading="lazy">`;
      }
      if (/^https?:\/\//i.test(s)) {
        return `<a href="${escapeHtml(s)}" target="_blank" rel="noopener">${escapeHtml(s)}</a>`;
      }
      if (s === "TRUE" || s === "FALSE") {
        return `<span class="badge">${s === "TRUE" ? "âœ… æ˜¯" : "âŒ å¦"}</span>`;
      }
      return escapeHtml(s);
    }

    // åŒ¯å‡ºç›®å‰è¡¨æ ¼ç‚º CSVï¼ˆå¥—ç”¨ç›®å‰çš„æœå°‹èˆ‡æ’åºï¼‰
    function csvEscape(v) { const s = String(v ?? ""); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
    function exportCsv() {
      const q = ($("#q")?.value || "").trim().toLowerCase();
      let rows = rawRows.filter(r => !q || r.some(cell => String(cell).toLowerCase().includes(q)));
      const { index, dir } = sortState;
      rows.sort((a, b) => {
        const x = a[index], y = b[index];
        const nx = parseFloat(x), ny = parseFloat(y);
        if (!isNaN(nx) && !isNaN(ny)) return (nx - ny) * dir;
        const dx = Date.parse(x), dy = Date.parse(y);
        if (!isNaN(dx) && !isNaN(dy)) return (dx - dy) * dir;
        return String(x).localeCompare(String(y), "zh-Hant") * dir;
      });
      const headers = rawHeaders.length ? rawHeaders : rows[0]?.map((_,i)=>`æ¬„ä½${i+1}`) || [];
      const lines = [ headers.map(csvEscape).join(","), ...rows.map(r => r.map(csvEscape).join(",")) ].join("\n");
      const blob = new Blob([lines], { type: "text/csv;charset=utf-8" });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href = url; a.download = `sheet-export-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.csv`;
      a.click(); URL.revokeObjectURL(url);
    }

    // äº‹ä»¶
    $("#q")?.addEventListener("input", render);
    $("#btn-refresh")?.addEventListener("click", fetchSheet);
    $("#btn-export")?.addEventListener("click", exportCsv);

    // è‡ªå‹•æ›´æ–°ï¼ˆå«é€€é¿ï¼šé€£çºŒéŒ¯èª¤æ™‚æ‹‰é•·é–“éš”ï¼‰
    let consecutiveErrors = 0;
    async function autoRefreshLoop() {
      try { await fetchSheet(); consecutiveErrors = 0; }
      catch { consecutiveErrors++; }
      const wait = REFRESH_MS * Math.min(1 + consecutiveErrors, 6);
      const b = $("#refresh-badge"); if (b) b.textContent = `æ¯ ${Math.round(wait/1000)} ç§’æ›´æ–°`;
      timerId = setTimeout(autoRefreshLoop, wait);
    }

    // é¦–æ¬¡è¼‰å…¥
    autoRefreshLoop();
    // é›¢é–‹é é¢æ¸…ç†
    window.addEventListener("beforeunload", () => { if (timerId) clearTimeout(timerId); });
  </script>
</body>
</html>
